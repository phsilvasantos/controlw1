unit creceberposicao;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls, ExtCtrls,IBQuery, Grids, DBGrids, DB, DBClient, Provider,
  DBCtrls, IBCustomDataSet, IBTable;

type
  TForm34 = class(TForm)
    DBGrid1: TDBGrid;
    Panel1: TPanel;
    cliente: TLabel;
    label4: TLabel;
    IBTable1: TIBTable;
    IBTable1CODGRU: TIntegerField;
    IBTable1DOCUMENTO: TIntegerField;
    IBTable1VENCIMENTO: TDateField;
    IBTable1TOTAL: TIBBCDField;
    IBTable1CODHIS: TIntegerField;
    IBTable1HISTORICO: TIBStringField;
    IBTable1PAGO: TIBBCDField;
    IBTable1FORNEC: TIntegerField;
    IBTable1USUARIO: TIntegerField;
    IBTable1VENDEDOR: TIntegerField;
    IBTable1DATAMOV: TDateField;
    IBTable1FORMPAGTO: TSmallintField;
    IBTable1PREVISAO: TDateField;
    IBTable1VALOR: TIBBCDField;
    IBTable1CONT: TSmallintField;
    IBTable1DATA: TDateField;
    IBTable1COD: TIntegerField;
    IBTable1ValorCalc: TCurrencyField;
    DataSource1: TDataSource;
    Label1: TLabel;
    Label2: TLabel;
    Panel2: TPanel;
    Label3: TLabel;
    Label5: TLabel;
    total: TLabel;
    IBTable1SALDO: TIBBCDField;
    procedure FormShow(Sender: TObject);
    procedure IBTable1CalcFields(DataSet: TDataSet);
    procedure DBGrid1DrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure DBGrid1KeyPress(Sender: TObject; var Key: Char);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure DBGrid1KeyUp(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure DBGrid1KeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
  private
    { Private declarations }
  public
   cont :  integer;
   juros,dias,saldo1 : currency;
   client1:string;
   function geraSaldo : boolean;
   procedure geraRecibo();
   function verificaValorNegativo() : boolean;
    { Public declarations }
  end;

var
  Form34: TForm34;


implementation

uses func, Unit1, principal, relatorio, imprime1, DateUtils, Math;

{$R *.dfm}

function TForm34.verificaValorNegativo() : boolean;
begin
  try
    Result := false;
    IBTable1.DisableControls;
    IBTable1.First;
    while not IBTable1.Eof do
      begin
        If IBTable1ValorCalc.AsCurrency < 0 then
          begin
            Result := true;
            break;
          end;
        IBTable1.Next;
      end;
  finally
    IBTable1.First;
    IBTable1.EnableControls;
  end;
end;

procedure TForm34.geraRecibo();
begin

end;


function tform34.geraSaldo : boolean;
begin
  IBTable1.DisableControls;
  IBTable1.First;
  saldo1 := 0;

  while not IBTable1.Eof do
    begin
      IBTable1.Edit;
      saldo1 := saldo1 + TIBQuery(IBTable1).fieldbyname('valorcalc').AsCurrency;
      IBTable1SALDO.AsCurrency := saldo1;
      IBTable1.Post;
      IBTable1.Next;
    end;
  try
   IBTable1.Transaction.Commit;
  except
   IBTable1.Transaction.Rollback;
  end;
  IBTable1.Active := true ;
  IBTable1.First;
  IBTable1.EnableControls;
  funcoes.FormataCampos(tibquery(IBTable1),2,'',2);
  Result := true;
end;

procedure TForm34.FormShow(Sender: TObject);
begin

if cont=1 then
begin
 IBTable1SALDO.Visible := false;

 Panel1.Visible := false;
 try
  total.Caption := CurrToStrF(funcoes.SomaCampoDBGRID(tibquery(ibtable1),'ValorCalc',0,0,0,''),ffnumber,2);
 except
 end;

end;
if cont = 2 then
 begin
   IBTable1.IndexName := 'CONTASRECEBER_IDX1';
   geraSaldo();
   panel2.Visible := false;
 end;
end;

procedure TForm34.IBTable1CalcFields(DataSet: TDataSet);
var
  d : real;
  i : integer;
  datamaior : TDateTime;
begin
if IBTable1DATA.AsDateTime>=IBTable1VENCIMENTO.AsDateTime then datamaior:=IBTable1DATA.AsDateTime
 else datamaior := IBTable1VENCIMENTO.AsDateTime;
 if cont = 1 then
   begin
    IBTable1ValorCalc.AsCurrency := IBTable1VALOR.AsCurrency
   end
else if cont=2 then
 begin
    i:=0;
    if form22.datamov>datamaior then
      begin
        d := form22.datamov - datamaior;
        IBTable1ValorCalc.AsCurrency := IBTable1VALOR.AsCurrency + Arredonda(((juros*IBTable1VALOR.AsCurrency)/100)*d,2);
      end
    else  IBTable1ValorCalc.AsCurrency := IBTable1VALOR.AsCurrency;
 end
else if cont=3 then IBTable1ValorCalc.AsCurrency :=IBTable1VALOR.AsCurrency;
end;

procedure TForm34.DBGrid1DrawColumnCell(Sender: TObject; const Rect: TRect;
  DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
if cont=1 then
begin
 if IBTable1.RecNo mod 2 = 0 then
  begin
   Dbgrid1.Canvas.Font.Color := clDkGray;
   Dbgrid1.DefaultDrawDataCell(Rect, dbgrid1.columns[datacol].field, State);
  end;
end;
end;

procedure TForm34.DBGrid1KeyPress(Sender: TObject; var Key: Char);
var
   valorbaixado , sim, cod, fatura :string;
   i, a, c, lin            : integer;
   v1 , valorb             : currency;
   _LIQ                    : boolean;
begin
if cont = 1 then if (key=#27) or (key=#13) then close;
if cont = 2 then
begin

 if key=#27 then Close;

 if key = #13 then
      begin
        c := IBTable1.RecNo-1;
        //loop para nao receber valor acima do valor da conta
        valorbaixado:='999999999';
        while StrToCurr(funcoes.ConverteNumerico(valorbaixado)) > IBTable1ValorCalc.AsCurrency do
          begin
            try
              valorBaixado := funcoes.ConverteNumerico(funcoes.dialogo('numero',0,'1234567890,.'+#8,2,false,'',Application.Title,'O Valor é R$ '+FormatCurr('#,###,##0.00',IBTable1ValorCalc.Ascurrency)+' .Qual o Valor a Ser Baixado?',FormatCurr('#,###,###0.00',IBTable1ValorCalc.AsCurrency)));
              if valorbaixado='*' then
                begin
                  break;
                  exit;
                end;
              //se for maior dá uma mensagem que excedeu o valor da conta
              if StrToCurr(funcoes.ConverteNumerico(valorbaixado))>IBTable1ValorCalc.AsCurrency then  ShowMessage('Valor Excedeu o Total da Conta!');
            except
              exit;
            end;
          end;

        try
          if (valorbaixado = '*') or (StrToCurr(valorbaixado) = 0) then exit;
        except
        end;

        if messageDlg('Confirma Baixa de R$ '+valorBaixado+' ?', mtConfirmation, [mbyes, mbNo], 0) = mrYes then sim := 'S'
          else sim := '*';
        //sim := funcoes.dialogo('generico',0,'SN',0,true,'S',Application.Title,'Confirma Baixa de R$ '+valorBaixado+' ?','') ;
        if sim = '*' then exit;
        if (sim = 'S') then
          begin
            valorb := StrToCurr(funcoes.ConverteNumerico(valorbaixado));
            form19.RichEdit1.Clear;

            cod := IBTable1COD.AsString;
            v1 := IBTable1ValorCalc.AsCurrency;
            lin := 0;

            if ((Form22.Pgerais.Values['nota'] = 'T') or (Form22.Pgerais.Values['nota'] = 'D')) then
              begin
                form19.RichEdit1.Clear;
                form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(#13+#10+#15)));
                form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('+','+','-',40)+#13+#10)));
                form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar('|'+funcoes.centraliza(UpperCase(funcoes.LerValorPGerais('empresa',form22.Pgerais)),' ',38)+'|'+#13+#10)));
                form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|','|','-',40)+#13+#10)));
                form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|DATA: '+FormatDateTime('dd/mm/yy',form22.datamov)+'          HORA: '+FormatDateTime('tt',now),'|',' ',40)+#13+#10)));
                form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('+','+','-',40)+#13+#10)));
                form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|RECIBO    Valor: '+FormatCurr('#,###,###0.00',valorb),' |',' ',40)+#13+#10)));
                form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('+','+','-',40)+#13+#10)));
                form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|','|',' ',40)+#13+#10)));
                form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|RECEBIDO DE:','|',' ',40)+#13+#10)));
                form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|'+copy(IBTable1HISTORICO.AsString,pos('-',IBTable1HISTORICO.AsString)+1,length(IBTable1HISTORICO.AsString) - 8),'|',' ',40)+#13+#10)));
                form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|','|',' ',40)+#13+#10)));
                form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|A IMPORTANCIA DE R$ '+FormatCurr('#,###,###0.00',valorb),'|',' ',40)+#13+#10)));
                form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|','|',' ',40)+#13+#10)));
                form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|REFERENTE:','|',' ',40)+#13+#10)));
                form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|','|',' ',40)+#13+#10)));
              end
            else
              begin
                {dm.IBQuery4.Close;
                dm.IBQuery4.SQL.Clear;
                dm.IBQuery4.SQL.Add('select * from registro');
                dm.IBQuery4.Open;

                form19.RichEdit1.Clear;
                addRelatorioForm19(funcoes.CompletaOuRepete('+', '+', '-', 52) + funcoes.CompletaOuRepete('', '+', '-', 18) + #13 + #10);
                addRelatorioForm19(funcoes.CompletaOuRepete('|' + funcoes.centraliza(form22.Pgerais.Values['empresa'], ' ', 50), '|', ' ', 52) + funcoes.CompletaOuRepete(funcoes.centraliza('R E C I B O', ' ', 16) , '|', ' ', 18) + #13 + #10);
                addRelatorioForm19(funcoes.CompletaOuRepete('|' + funcoes.centraliza(dm.IBQuery4.fieldbyname('ende').AsString + ' - ' + dm.IBQuery4.fieldbyname('bairro').AsString, ' ', 50), '|', ' ', 52) + funcoes.CompletaOuRepete(funcoes.centraliza('100', ' ', 16), '|', ' ', 18) + #13 + #10);
                addRelatorioForm19(funcoes.CompletaOuRepete('|' + funcoes.centraliza(dm.IBQuery4.fieldbyname('cnpj').AsString, ' ', 50), '|', ' ', 52) + funcoes.CompletaOuRepete('', '|', ' ', 18) + #13 + #10);                                                                        //funcoes.CompletaOuRepete(funcoes.centraliza('R$ ' + FormatDateTime('#,###,###0.00', valorb)
                addRelatorioForm19(funcoes.CompletaOuRepete('|' + funcoes.centraliza('Fone: ' + dm.IBQuery4.fieldbyname('telres').AsString + ' Fax: ' + dm.IBQuery4.fieldbyname('telcom').AsString, ' ', 50), '|', ' ', 52) + funcoes.CompletaOuRepete(funcoes.centraliza('R$ ' + FormatCurr('#,###,###0.00', valorb), ' ', 16), '|', ' ', 18) + #13 + #10);
                addRelatorioForm19(funcoes.CompletaOuRepete('+', '+', '-', 70) + #13 + #10);}

                dm.IBQuery2.Close;
                       fatura := funcoes.novocod('RECIBO_PAGA');

      dm.IBQuery2.Close;
      dm.IBQuery2.SQL.Text := ('select ende,bairro,cnpj,telres,telcom,cid,est from registro');
      dm.IBQuery2.Open;

      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#218,'',#196,57)+funcoes.CompletaOuRepete(#194,#191,#196,21)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179+funcoes.centraliza(form22.Pgerais.Values['empresa'],' ',56),'',' ',57)+funcoes.CompletaOuRepete(#179+'   R E C I B O',#179,' ',21)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179+funcoes.centraliza(dm.IBQuery2.fieldbyname('ende').AsString+' - '+dm.IBQuery2.fieldbyname('bairro').AsString,' ',56),'',' ',57)+funcoes.CompletaOuRepete(#179+funcoes.centraliza( fatura,' ',19),#179,' ',21)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179+funcoes.centraliza('CNPJ: '+dm.IBQuery2.fieldbyname('cnpj').AsString,' ',56),'',' ',57)+funcoes.CompletaOuRepete(#179,#179,' ',21)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179+funcoes.centraliza('FONE: '+dm.IBQuery2.fieldbyname('TELRES').AsString+'   FAX: '+dm.IBQuery2.fieldbyname('TELCOM').AsString,' ',56),'',' ',57)+funcoes.CompletaOuRepete(#179+'R$:'+funcoes.CompletaOuRepete('',FormatCurr('#,###,###0.00', valorb),' ',15),#179,' ',21)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#195,'',#196,12)+funcoes.CompletaOuRepete('','',#196,9)+funcoes.CompletaOuRepete('','',#196,6)+funcoes.CompletaOuRepete('','',#196,12)+funcoes.CompletaOuRepete('','',#196,12)+funcoes.CompletaOuRepete(''+#196+#196+#196+#196+#196+#196+#193,'',#196,9)+funcoes.CompletaOuRepete('','',#196,6)+funcoes.CompletaOuRepete('',#180,#196,12)+#13+#10))));


      {          addRelatorioForm19(funcoes.CompletaOuRepete('| RECEBEMOS DE ' + copy(IBTable1HISTORICO.AsString, pos('-', IBTable1HISTORICO.AsString) + 1, length(IBTable1HISTORICO.AsString) - 8),'COD.: ' + '100' + '|', ' ', 70) + #13 + #10);
                addRelatorioForm19(funcoes.CompletaOuRepete('+', '+', '-', 70) + #13 + #10);
                addRelatorioForm19(funcoes.CompletaOuRepete('| A IMPORTANCIA DE ' + UpperCase(funcoes.valorPorExtenso(valorb)) ,'|', ' ', 70) + #13 + #10);
                addRelatorioForm19(funcoes.CompletaOuRepete('|','|', ' ', 70) + #13 + #10);
                addRelatorioForm19(funcoes.CompletaOuRepete('| REFERENTE A:' ,'|', ' ', 70) + #13 + #10);}

                form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179+' RECEBEMOS DE '+copy(IBTable1HISTORICO.AsString, pos('-', IBTable1HISTORICO.AsString) + 1, length(IBTable1HISTORICO.AsString) - 8),'COD.: ' +IBTable1DOCUMENTO.AsString+#179,' ',78)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',78)+#13+#10))));
      funcoes.QuebraLinhas(#179,#179,' A IMPORTANCIA DE '+ UpperCase(funcoes.valorPorExtenso(valorb)), 78);
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',78)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179+' REFERENTE A: ',#179,' ',78)+#13+#10))));


              end;

            if StrToCurr(funcoes.ConverteNumerico(valorBaixado)) = IBTable1ValorCalc.AsCurrency then
              begin
                dm.IBQuery2.Close;
                dm.IBQuery2.SQL.Clear;
                dm.IBQuery2.SQL.Add('update contasreceber set valor = :valor,pago = pago + :pago,data=:data where cod='+cod);
                dm.IBQuery2.ParamByName('valor').AsCurrency :=IBTable1VALOR.AsCurrency-StrToCurr(funcoes.ConverteNumerico(valorBaixado));
                dm.IBQuery2.ParamByName('pago').AsCurrency := StrToCurr(funcoes.ConverteNumerico(valorBaixado));
                dm.IBQuery2.ParamByName('data').AsDateTime := form22.datamov;
                try
                 dm.IBQuery2.ExecSQL;

                 if ((Form22.Pgerais.Values['nota'] = 'T') or (Form22.Pgerais.Values['nota'] = 'D')) then
                   begin
                     form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|'+copy(IBTable1HISTORICO.AsString,1,18)+' '+copy(IBTable1HISTORICO.AsString,length(IBTable1HISTORICO.AsString)-5,length(IBTable1HISTORICO.AsString)),FormatCurr('#,###,###0.00',IBTable1ValorCalc.AsCurrency)+'|',' ',40)+#13+#10)));
                   end
                 else
                   begin
                     lin := lin + 1;
                     funcoes.QuebraLinhas(#179,#179,' '+FormatDateTime('dd/mm/yy', IBTable1VENCIMENTO.AsDateTime)+'  '+ IBTable1HISTORICO.AsString +'          '+FormatCurr('#,###,###0.00', valorb),78);
                     //addRelatorioForm19(funcoes.CompletaOuRepete('|' + FormatDateTime('dd/mm/yy', IBTable1DATA.AsDateTime) + ' ' + funcoes.CompletaOuRepete(IBTable1HISTORICO.AsString, FormatCurr('#,###,###0.00',IBTable1ValorCalc.AsCurrency), ' ', 50),'|', ' ', 70) + #13 + #10);
                   end;
                except
                end;
              end
            else if StrToCurr(funcoes.ConverteNumerico(valorBaixado)) < IBTable1ValorCalc.AsCurrency then
              begin
              {  if MessageBox(Handle, 'Deseja Liquidar Esta Conta com Valor a Menor ?', pchar(Application.Title), MB_YESNO + MB_ICONQUESTION + MB_DEFBUTTON2) = idyes then _LIQ := true
                   else _LIQ := False;
               }

                _LIQ := false;
                dm.IBQuery2.Close;
                dm.IBQuery2.SQL.Clear;
                if _LIQ then
                  begin
                    dm.IBQuery2.SQL.Add('update contasreceber set valor = :valor, data = :data, pago = :pago where cod='+IBTable1COD.AsString);
                    dm.IBQuery2.ParamByName('valor').AsCurrency := IBTable1ValorCalc.AsCurrency - StrToCurr(funcoes.ConverteNumerico(valorBaixado));
                    dm.IBQuery2.ParamByName('data').AsDateTime  := form22.datamov;
                    dm.IBQuery2.ParamByName('pago').AsCurrency := IBTable1ValorCalc.AsCurrency - StrToCurr(funcoes.ConverteNumerico(valorBaixado));
                  end
                else
                  begin
                    dm.IBQuery2.SQL.Add('update contasreceber set valor = :valor,data=:data where cod='+IBTable1COD.AsString);
                    dm.IBQuery2.ParamByName('valor').AsCurrency :=IBTable1ValorCalc.AsCurrency - StrToCurr(funcoes.ConverteNumerico(valorBaixado));
                    dm.IBQuery2.ParamByName('data').AsDateTime := form22.datamov;
                  end;
                try
                  dm.IBQuery2.ExecSQL;
                  if ((Form22.Pgerais.Values['nota'] = 'T') or (Form22.Pgerais.Values['nota'] = 'D')) then
                    begin
                      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|'+copy(IBTable1HISTORICO.AsString,1,18)+' '+copy(IBTable1HISTORICO.AsString,length(IBTable1HISTORICO.AsString)-5,length(IBTable1HISTORICO.AsString)),FormatCurr('#,###,###0.00',IBTable1ValorCalc.AsCurrency)+'|',' ',40)+#13+#10)));
                   end
                 else
                   begin
                     lin := lin + 1;
                     //addRelatorioForm19(funcoes.CompletaOuRepete('|' + FormatDateTime('dd/mm/yy', IBTable1DATA.AsDateTime) + ' ' + funcoes.CompletaOuRepete(IBTable1HISTORICO.AsString, FormatCurr('#,###,###0.00',IBTable1ValorCalc.AsCurrency), ' ', 50),'|', ' ', 70) + #13 + #10);
                   end;
                except
                  dm.IBQuery2.Transaction.Rollback;
                  ShowMessage('Erro Inesperado! Tente Novamente');
                end;
              end;
            dm.IBQuery2.Close;
            dm.IBQuery2.SQL.Clear;
            dm.IBQuery2.SQL.Add('insert into caixa(formpagto,codgru,codmov,codentradasaida,data,documento,vencimento,codhis,historico,entrada,usuario) values (1,'+IBTable1CODGRU.AsString+','+funcoes.novocod('movcaixa')+','+cod+',:data,'+IBTable1DOCUMENTO.AsString+',:venc,'+IBTable1CODHIS.AsString+','+QuotedStr(IBTable1HISTORICO.AsString)+',:pago,'+form22.codusario+')');
            dm.IBQuery2.ParamByName('data').AsDateTime := DateOf(form22.datamov) + timeof(now);
            dm.IBQuery2.ParamByName('venc').AsDateTime := IBTable1VENCIMENTO.AsDateTime;
            dm.IBQuery2.ParamByName('pago').AsCurrency := StrToCurr(funcoes.ConverteNumerico(valorBaixado));

            try
              dm.IBQuery2.ExecSQL;
              dm.IBQuery2.Transaction.Commit;

              if ((Form22.Pgerais.Values['nota'] = 'T') or (Form22.Pgerais.Values['nota'] = 'D')) then
                begin
                  form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('+','+','-',40)+ #13 + #10)));
               end
              else
                begin
                  dm.IBQuery2.Close;
                  dm.IBQuery2.SQL.Text := ('select ende,bairro,cnpj,telres,telcom,cid,est from registro');
                  dm.IBQuery2.Open;

                  form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',78)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',78)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',78)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',78)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',78)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',78)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',78)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#195,#194,#196,30)+funcoes.CompletaOuRepete('',#194,#196,15)+funcoes.CompletaOuRepete('',#180,#196,33)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179+' CHEQUE Nr.:',#179,' ',30)+funcoes.CompletaOuRepete(' BANCO:',#179,' ',15)+funcoes.CompletaOuRepete(' CONTA:',#179,' ',33)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',30)+funcoes.CompletaOuRepete('',#179,' ',15)+funcoes.CompletaOuRepete('',#179,' ',33)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#195+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#193,#197,#196,45)+funcoes.CompletaOuRepete('',#180,#196,33)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',45)+funcoes.CompletaOuRepete('',#179,' ',33)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179+'   '+dm.IBQuery2.fieldbyname('cid').AsString+' - '+dm.IBQuery2.fieldbyname('est').AsString+', '+FormatDateTime('dd',form22.datamov)+' DE '+UpperCase(FormatDateTime('MMMM',form22.datamov))+' DE '+FormatDateTime('YYYY',form22.datamov),#179,' ',45)+funcoes.CompletaOuRepete('',#179,' ',33)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',45)+funcoes.CompletaOuRepete('            Assinatura',#179,' ',33)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#192,#193,#196,45)+funcoes.CompletaOuRepete('',#217,#196,33)+#13+#10))));
                  {for lin := lin to 10 do
                    begin
                      addRelatorioForm19(funcoes.CompletaOuRepete('|','|', ' ', 70) + #13 + #10); // pula linhas em branco
                    end;

                 addRelatorioForm19(funcoes.CompletaOuRepete('+','+', '-', 26) + funcoes.CompletaOuRepete('','+', '-', 16) + funcoes.CompletaOuRepete('','+', '-', 28) + #13 + #10);
                 addRelatorioForm19(funcoes.CompletaOuRepete('| CHEQUE N.:' ,'|', ' ', 26) + funcoes.CompletaOuRepete(' BANCO: ','|', ' ', 16) + funcoes.CompletaOuRepete(' CONTA:','|', ' ', 28) + #13 + #10);
                 addRelatorioForm19(funcoes.CompletaOuRepete('|' ,'|', ' ', 26) + funcoes.CompletaOuRepete('','|', ' ', 16) + funcoes.CompletaOuRepete('','|', ' ', 28) + #13 + #10);
                 addRelatorioForm19(funcoes.CompletaOuRepete('+','+', '-', 26) + funcoes.CompletaOuRepete('','+', '-', 16) + funcoes.CompletaOuRepete('','+', '-', 28) + #13 + #10);
                 addRelatorioForm19(funcoes.CompletaOuRepete('|','|', ' ', 42) + funcoes.CompletaOuRepete('','|', ' ', 28) + #13 + #10);
                 addRelatorioForm19(funcoes.CompletaOuRepete('|' + dm.IBQuery4.fieldbyname('cid').AsString + ' - ' + dm.IBQuery4.fieldbyname('est').AsString + ', ' + FormatDateTime('d', Form22.datamov) + ' DE ' + UpperCase(FormatDateTime('mmmm', Form22.datamov)) + ' DE ' + FormatDateTime('yyyy', Form22.datamov)  ,'|', ' ', 42) + funcoes.CompletaOuRepete('','|', ' ', 28) + #13 + #10);
                 addRelatorioForm19(funcoes.CompletaOuRepete('|','|', ' ', 42) + funcoes.CompletaOuRepete('  RECEBIDO POR VENDEDOR','|', ' ', 28) + #13 + #10);
                 addRelatorioForm19(funcoes.CompletaOuRepete('+','+', '-', 42) + funcoes.CompletaOuRepete('','+', '-', 28) + #13 + #10);

                 dm.IBQuery4.Close;}
                end;

              sim := funcoes.valorPorExtenso(abs(valorb));
              sim := UpperCase(copy(sim,1,1))+copy(sim,2,length(sim));
              valorbaixado := '';
              i := 0;
              while i <> length(sim) do
                begin
                  i := i + 1;
                  if sim[i] = ' ' then a := i;
                  valorbaixado := valorbaixado + sim[i];
                    if length(valorbaixado) = 38 then
                      begin
                       //sim := copy(sim,1,i);
                       if ((Form22.Pgerais.Values['nota'] = 'T') or (Form22.Pgerais.Values['nota'] = 'D')) then
                         begin
                           form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|'+TrimLeft(copy(valorbaixado,1,a)),'|',' ',40)+#13+#10)));
                         end;
                       valorbaixado := copy(valorbaixado,length(copy(valorbaixado,1,a)),length(valorbaixado));
                      end
                    else if i = length(sim) then
                      begin
                        if ((Form22.Pgerais.Values['nota'] = 'T') or (Form22.Pgerais.Values['nota'] = 'D')) then
                          begin
                            form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|'+TrimLeft(valorbaixado),'|',' ',40)+#13+#10)));
                          end;
                      end;
                end;
                
              if ((Form22.Pgerais.Values['nota'] = 'T') or (Form22.Pgerais.Values['nota'] = 'D')) then
                begin
                  form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('+','+','-',40)+#13+#10)));
                  form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|','|',' ',40)+#13+#10)));
                  form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|RECEBIDO POR:','|',' ',40)+#13+#10)));
                  form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|','|',' ',40)+#13+#10)));
                  form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|','|',' ',40)+#13+#10)));
                  form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('+','+','-',40)+#13+#10)));
                end;
              IBTable1.Active := false;
              IBTable1.Open;
              geraSaldo;
              IBTable1.Active :=true;
              IBTable1.DisableControls;
              IBTable1.First;
              IBTable1.MoveBy(c);
              iBTable1.EnableControls;

              sim := funcoes.dialogo('generico',0,'SN',0,true,'S',Application.Title,'Deseja Imprimir o Recibo de Pagamento?','N') ;
              if sim = 'S' then
              begin
                imprime.setCofiguracoesImpressora;
                imprime.textxArq('texto.txt');
               //imprime.textx('texto.txt');
              end;
              cont := 2;
            except
            end;
          end;
      end;

end;
end;

procedure TForm34.FormClose(Sender: TObject; var Action: TCloseAction);
begin
IBTable1.Close;
end;

procedure TForm34.DBGrid1KeyUp(Sender: TObject; var Key: Word;
  Shift: TShiftState);
var cli,valorBaixado,sim, cod, codES, fatura:string;
var i,a :integer;
var v1,valorb:currency;
begin
  if cont = 2 then
   begin
    if key = 113 then
     begin

      dm.IBQuery2.Close;
      dm.IBQuery2.SQL.Clear;
      dm.IBQuery2.SQL.Add('select cod,nome,ende,bairro,cid,est,cnpj,ies from cliente where cod='+IBTable1DOCUMENTO.AsString);
      dm.IBQuery2.Open;
      cli := dm.IBQuery2.fieldbyname('nome').AsString;

      form19.RichEdit1.Clear;
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete('','','-',78)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(funcoes.CompletaOuRepete(funcoes.LerValorPGerais('empresa',form22.Pgerais),'',' ',35)+'EXTRATO DE CONTA',FormatDateTime('dd/mm/yy',form22.datamov),' ',78)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete('','','-',78)+#13+#10))));
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete('CLIENTE: '+IBTable1DOCUMENTO.AsString +'-'+cli,FormatDateTime('tt',now),' ',78)+#13+#10))));
      addRelatorioForm19('END.: ' + dm.IBQuery2.fieldbyname('ende').AsString + ' BAIRRO: ' + dm.IBQuery2.fieldbyname('BAIRRO').AsString + CRLF);
      addRelatorioForm19('CIDADE: ' + dm.IBQuery2.fieldbyname('cid').AsString + ' ESTADO: ' + dm.IBQuery2.fieldbyname('est').AsString + CRLF);
      addRelatorioForm19('CPF/CNPJ: ' + dm.IBQuery2.fieldbyname('cnpj').AsString  + CRLF);
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete('','','-',78)+#13+#10))));
      addRelatorioForm19('VENCIMENTO  HISTORICO                                VALOR             SALDO'  + CRLF);
      form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete('','','-',78)+#13+#10))));

      dm.IBQuery2.Close;
      IBTable1.DisableControls;
      i:= IBTable1.RecNo-1;
      IBTable1.First;

      while not IBTable1.Eof do
       begin
        if form19.RichEdit1.Lines.Count >= 55 then
          begin
            form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete('','','-',78)+#12+#13+#10))));
            form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete('','','-',78)+#13+#10))));
            form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(funcoes.CompletaOuRepete(funcoes.LerValorPGerais('empresa',form22.Pgerais),'',' ',35)+'EXTRATO DE CONTA',FormatDateTime('dd/mm/yy',form22.datamov),' ',78)+#13+#10))));
            form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete('CLIENTE: '+IBTable1DOCUMENTO.AsString +'-'+cli,FormatDateTime('tt',now),' ',78)+#13+#10))));
            form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete('','','-',78)+#13+#10))));
          end;
          form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(FormatDateTime('dd/mm/yy',IBTable1VENCIMENTO.AsDateTime),'',' ',12)+funcoes.CompletaOuRepete(IBTable1HISTORICO.AsString,'',' ',35)+funcoes.CompletaOuRepete(' ',FormatCurr('#,###,###0.00',IBTable1ValorCalc.ascurrency),' ',13)+'    '+funcoes.CompletaOuRepete(' ',FormatCurr('#,###,###0.00',IBTable1SALDO.ascurrency),' ',14))+#13+#10)));
          IBTable1.Next;
       end;
       IBTable1.First;
       IBTable1.MoveBy(i);
       IBTable1.EnableControls;
       form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete('','','-',78)+#13+#10))));
       imprime.textx('\texto.txt');
       form19.RichEdit1.Clear;
     end;

if key=121 then //F10
begin
  //aqui verifica se existe algum valor negativo pq se existir na hora de baixar duplica
  //asentradas em caixa
  if verificaValorNegativo then
    begin
      WWMessage('Foi detectado uma conta negativa, primeiro dê baixa desta conta utilizando ENTER para poder baixar utilizar esta função', mtWarning,[mbok], HexToTColor('FFD700'),true,false, HexToTColor('B22222'));
      exit;
    end;

  valorBaixado := funcoes.ConverteNumerico(funcoes.dialogo('numero',0,'1234567890,.'+#8,2,false,'',Application.Title,'Qual o Valor a Ser Baixado?','0,00'));
  if (valorBaixado = '*') then exit;
  try
    if (StrToCurr(valorBaixado) = 0)  then exit;
  except
    exit;
  end;

   
  sim := funcoes.dialogo('generico',0,'SN',0,false,'S',Application.Title,'Confirma Baixa de R$ '+valorBaixado+' ?','S') ;
  if sim = '*' then exit;
  if (not funcoes.Contido('*',valorBaixado+sim)) and (sim='S') then
   begin
     try
      valorb := StrToCurr(funcoes.ConverteNumerico(valorBaixado));
      v1 := valorb;
     except
       exit;
     end;
      i := IBTable1.RecNo-1;
      IBTable1.DisableControls;
      IBTable1.First;
      form19.RichEdit1.Clear;

      if ((Form22.Pgerais.Values['nota'] = 'T') or (Form22.Pgerais.Values['nota'] = 'D')) then
        begin
          form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(#13+#10+#15)));
          form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('+','+','-',40)+#13+#10)));
          form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar('|'+funcoes.centraliza(UpperCase(funcoes.LerValorPGerais('empresa',form22.Pgerais)),' ',38)+'|'+#13+#10)));
          form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|','|','-',40)+#13+#10)));
          form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|DATA: '+FormatDateTime('dd/mm/yy',form22.datamov)+'          HORA: '+FormatDateTime('tt',now),'|',' ',40)+#13+#10)));
          form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('+','+','-',40)+#13+#10)));
          form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|RECIBO    Valor: '+FormatCurr('#,###,###0.00',valorb),' |',' ',40)+#13+#10)));
          form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('+','+','-',40)+#13+#10)));
          form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|','|',' ',40)+#13+#10)));
          form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|RECEBIDO DE:','|',' ',40)+#13+#10)));
          form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|'+copy(IBTable1HISTORICO.AsString,pos('-',IBTable1HISTORICO.AsString)+1,length(IBTable1HISTORICO.AsString)-6),'|',' ',40)+#13+#10)));
          form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|','|',' ',40)+#13+#10)));
          form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|A IMPORTANCIA DE R$ '+FormatCurr('#,###,###0.00',valorb),'|',' ',40)+#13+#10)));
          form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|','|',' ',40)+#13+#10)));
          form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|REFERENTE:','|',' ',40)+#13+#10)));
          form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|','|',' ',40)+#13+#10)));
       end
     else
       begin
         dm.IBQuery2.Close;
         dm.IBQuery2.SQL.Text := ('select ende,bairro,cnpj,telres,telcom,cid,est from registro');
         dm.IBQuery2.Open;
         fatura := funcoes.novocod('RECIBO_PAGA');

         form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#218,'',#196,57)+funcoes.CompletaOuRepete(#194,#191,#196,21)+#13+#10))));
         form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179+funcoes.centraliza(form22.Pgerais.Values['empresa'],' ',56),'',' ',57)+funcoes.CompletaOuRepete(#179+'   R E C I B O',#179,' ',21)+#13+#10))));
         form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179+funcoes.centraliza(dm.IBQuery2.fieldbyname('ende').AsString+' - '+dm.IBQuery2.fieldbyname('bairro').AsString,' ',56),'',' ',57)+funcoes.CompletaOuRepete(#179+funcoes.centraliza( fatura,' ',19),#179,' ',21)+#13+#10))));
         form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179+funcoes.centraliza('CNPJ: '+dm.IBQuery2.fieldbyname('cnpj').AsString,' ',56),'',' ',57)+funcoes.CompletaOuRepete(#179,#179,' ',21)+#13+#10))));
         form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179+funcoes.centraliza('FONE: '+dm.IBQuery2.fieldbyname('TELRES').AsString+'   FAX: '+dm.IBQuery2.fieldbyname('TELCOM').AsString,' ',56),'',' ',57)+funcoes.CompletaOuRepete(#179+'R$:'+funcoes.CompletaOuRepete('',FormatCurr('#,###,###0.00', valorb),' ',15),#179,' ',21)+#13+#10))));
         form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#195,'',#196,12)+funcoes.CompletaOuRepete('','',#196,9)+funcoes.CompletaOuRepete('','',#196,6)+funcoes.CompletaOuRepete('','',#196,12)+funcoes.CompletaOuRepete('','',#196,12)+funcoes.CompletaOuRepete(''+#196+#196+#196+#196+#196+#196+#193,'',#196,9)+funcoes.CompletaOuRepete('','',#196,6)+funcoes.CompletaOuRepete('',#180,#196,12)+#13+#10))));

         {dm.IBQuery4.Close;
         dm.IBQuery4.SQL.Clear;
         dm.IBQuery4.SQL.Add('select * from registro');
         dm.IBQuery4.Open;

         form19.RichEdit1.Clear;
         addRelatorioForm19(funcoes.CompletaOuRepete('+', '+', '-', 52) + funcoes.CompletaOuRepete('', '+', '-', 18) + #13 + #10);
         addRelatorioForm19(funcoes.CompletaOuRepete('|' + funcoes.centraliza(form22.Pgerais.Values['empresa'], ' ', 50), '|', ' ', 52) + funcoes.CompletaOuRepete(funcoes.centraliza('R E C I B O', ' ', 16) , '|', ' ', 18) + #13 + #10);
         addRelatorioForm19(funcoes.CompletaOuRepete('|' + funcoes.centraliza(dm.IBQuery4.fieldbyname('ende').AsString + ' - ' + dm.IBQuery4.fieldbyname('bairro').AsString, ' ', 50), '|', ' ', 52) + funcoes.CompletaOuRepete(funcoes.centraliza('100', ' ', 16), '|', ' ', 18) + #13 + #10);
         addRelatorioForm19(funcoes.CompletaOuRepete('|' + funcoes.centraliza(dm.IBQuery4.fieldbyname('cnpj').AsString, ' ', 50), '|', ' ', 52) + funcoes.CompletaOuRepete('', '|', ' ', 18) + #13 + #10);
         addRelatorioForm19(funcoes.CompletaOuRepete('|' + funcoes.centraliza('Fone: ' + dm.IBQuery4.fieldbyname('telres').AsString + ' Fax: ' + dm.IBQuery4.fieldbyname('telcom').AsString, ' ', 50), '|', ' ', 52) + funcoes.CompletaOuRepete(funcoes.centraliza('R$ ' + FormatCurr('#,###,###0.00', valorb), ' ', 16), '|', ' ', 18) + #13 + #10);
         addRelatorioForm19(funcoes.CompletaOuRepete('+', '+', '-', 70) + #13 + #10);


         addRelatorioForm19(funcoes.CompletaOuRepete('| RECEBEMOS DE ' + copy(IBTable1HISTORICO.AsString, pos('-', IBTable1HISTORICO.AsString) + 1, length(IBTable1HISTORICO.AsString) - 8),'COD.: ' + '100' + '|', ' ', 70) + #13 + #10);
         addRelatorioForm19(funcoes.CompletaOuRepete('+', '+', '-', 70) + #13 + #10);

         addRelatorioForm19(funcoes.CompletaOuRepete('| A IMPORTANCIA DE: ', '|', ' ', 70) + #13 + #10);}

         sim := UpperCase(funcoes.valorPorExtenso(valorb));
         i := 0;
         codES := '';
         {while i <> length(sim) do
           begin
             i := i + 1;
             if sim[i] = ' ' then a := i;
             codES := codES + sim[i];
             if length(codES) = 68 then
               begin
                 addRelatorioForm19(funcoes.CompletaOuRepete('| ' + TrimLeft(copy(codES, 1, a)) , '|', ' ', 70) + #13 + #10);
                 valorbaixado := copy(codES,length(copy(codES,1,a)),length(codES));
               end;
           end;
        if i = length(sim) then
          begin
            addRelatorioForm19(funcoes.CompletaOuRepete('| ' + TrimLeft(codES) ,'|', ' ', 70) + #13 + #10);
          end;}


         //addRelatorioForm19(funcoes.CompletaOuRepete('|','|', ' ', 70) + #13 + #10);
         //addRelatorioForm19(funcoes.CompletaOuRepete('| REFERENTE A:' ,'|', ' ', 70) + #13 + #10);
       end;

      //(valorb<>0)
      while ((not IBTable1.Eof) or (valorb <= 0)) do
       begin
        if (valorb <= 0) then break;
        if valorb >= IBTable1ValorCalc.AsCurrency then
          begin
            dm.IBQuery1.Close;
            dm.IBQuery1.SQL.Clear;
            dm.IBQuery1.SQL.Add('update contasreceber set valor=0,pago=:valor,data=:data where cod='+IBTable1COD.AsString);
            dm.IBQuery1.ParamByName('valor').AsCurrency := IBTable1ValorCalc.AsCurrency;
            dm.IBQuery1.ParamByName('data').AsDateTime  := form22.datamov;
            try
             valorb := valorb - IBTable1ValorCalc.AsCurrency;
             dm.IBQuery1.ExecSQL;
             dm.IBQuery1.Transaction.Commit;
             IBTable1.Active := true;
            except
             dm.IBQuery1.Transaction.Rollback;
             ShowMessage('Erro Inesperado! Tente Novamente');
            end;
             dm.IBQuery1.Close;
             dm.IBQuery1.SQL.Clear;
             dm.IBQuery1.SQL.Add('insert into caixa(formpagto,codgru,codmov,codentradasaida,data,documento,vencimento,codhis,historico,entrada,usuario) values (1,'+IBTable1CODGRU.AsString+','+funcoes.novocod('movcaixa')+','+IBTable1COD.AsString+',:data,'+IBTable1DOCUMENTO.AsString+',:venc,'+IBTable1CODHIS.AsString+','+QuotedStr(IBTable1HISTORICO.AsString)+',:pago,'+form22.codusario+')');
             dm.IBQuery1.ParamByName('data').AsDateTime := DateOf(form22.datamov) + timeof(now);
             dm.IBQuery1.ParamByName('venc').AsDateTime:= IBTable1VENCIMENTO.AsDateTime;
             dm.IBQuery1.ParamByName('pago').AsCurrency:= IBTable1ValorCalc.AsCurrency;

             try
              dm.IBQuery1.ExecSQL;
              dm.IBQuery1.Transaction.Commit;
              if ((Form22.Pgerais.Values['nota'] = 'T') or (Form22.Pgerais.Values['nota'] = 'D')) then
                begin
                  form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|'+copy(IBTable1HISTORICO.AsString,1,18)+' '+copy(IBTable1HISTORICO.AsString,length(IBTable1HISTORICO.AsString)-5,length(IBTable1HISTORICO.AsString)),FormatCurr('#,###,###0.00',IBTable1ValorCalc.AsCurrency)+'|',' ',40)+#13+#10)));
                end
             else
               begin
                 funcoes.QuebraLinhas(#179,#179,' '+FormatDateTime('dd/mm/yy', IBTable1VENCIMENTO.AsDateTime)+'  '+ IBTable1HISTORICO.AsString +'          '+FormatCurr('#,###,###0.00', IBTable1ValorCalc.AsCurrency),78);
                 //addRelatorioForm19(funcoes.CompletaOuRepete('|' + FormatDateTime('dd/mm/yy', IBTable1DATA.AsDateTime) + ' ' + funcoes.CompletaOuRepete(IBTable1HISTORICO.AsString, FormatCurr('#,###,###0.00',IBTable1ValorCalc.AsCurrency), ' ', 50),'|', ' ', 70) + #13 + #10);
               end;
             except
             end;
          end
         else if (valorb < IBTable1ValorCalc.AsCurrency) then
          begin
            //se valorb(valor que o usuario informou a ser dado baixa) menor valor da conta
            dm.IBQuery1.Close;
            dm.IBQuery1.SQL.Clear;
            dm.IBQuery1.SQL.Add('update contasreceber set valor=:valor where cod='+IBTable1COD.AsString);
            dm.IBQuery1.ParamByName('valor').AsCurrency := IBTable1ValorCalc.AsCurrency - valorb;
           try
             dm.IBQuery1.ExecSQL;
             dm.IBQuery1.Transaction.Commit;
             dm.IBQuery1.Close;
           except
             dm.IBQuery1.Transaction.Rollback;
             ShowMessage('Erro Inesperado! Tente Novamente');
           end;
             dm.IBQuery1.Close;
             dm.IBQuery1.SQL.Clear;
             dm.IBQuery1.SQL.Add('insert into caixa(formpagto,codgru,codmov,codentradasaida,data,documento,vencimento,codhis,historico,entrada,usuario) values (1,'+IBTable1CODGRU.AsString+','+funcoes.novocod('movcaixa')+','+IBTable1COD.AsString+',:data,'+IBTable1DOCUMENTO.AsString+',:venc,'+IBTable1CODHIS.AsString+','+QuotedStr(IBTable1HISTORICO.AsString)+',:pago,'+form22.codusario+')');
             dm.IBQuery1.ParamByName('data').AsDateTime := DateOf(form22.datamov) + timeof(now);
             dm.IBQuery1.ParamByName('venc').AsDateTime:= IBTable1VENCIMENTO.AsDateTime;
             dm.IBQuery1.ParamByName('pago').AsCurrency:= valorb;
           try
             dm.IBQuery1.ExecSQL;
             dm.IBQuery1.Transaction.Commit;
             if ((Form22.Pgerais.Values['nota'] = 'T') or (Form22.Pgerais.Values['nota'] = 'D')) then
               begin
                 form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|'+copy(IBTable1HISTORICO.AsString,1,18)+' '+copy(IBTable1HISTORICO.AsString,length(IBTable1HISTORICO.AsString)-5,length(IBTable1HISTORICO.AsString)),FormatCurr('#,###,###0.00',valorb)+'|',' ',40)+#13+#10)));
               end
             else
               begin
                 funcoes.QuebraLinhas(#179,#179,' '+FormatDateTime('dd/mm/yy', IBTable1VENCIMENTO.AsDateTime)+'  '+ IBTable1HISTORICO.AsString +'          '+FormatCurr('#,###,###0.00', valorb),78);
                 //addRelatorioForm19(funcoes.CompletaOuRepete('|' + FormatDateTime('dd/mm/yy', IBTable1DATA.AsDateTime) + ' ' + funcoes.CompletaOuRepete(IBTable1HISTORICO.AsString, FormatCurr('#,###,###0.00', valorb), ' ', 50),'|', ' ', 70) + #13 + #10);
               end;
             valorb := 0;
           except
           end;
          end;

        IBTable1.Next;
       end;
       end;

       if valorb <> 0 then
         begin
           dm.IBQuery1.SQL.Add('insert into caixa(formpagto,codgru,codmov,codentradasaida,data,documento,vencimento,codhis,historico,entrada,usuario) values (1,'+IBTable1CODGRU.AsString+','+funcoes.novocod('movcaixa')+','+IBTable1COD.AsString+',:data,'+IBTable1DOCUMENTO.AsString+',:venc,'+IBTable1CODHIS.AsString+','+QuotedStr(copy(IBTable1HISTORICO.AsString,1,length(IBTable1HISTORICO.AsString) - 5))+',:pago,'+form22.codusario+')');
           dm.IBQuery1.ParamByName('data').AsDateTime := DateOf(form22.datamov) + TimeOf(now);
           dm.IBQuery1.ParamByName('venc').AsDateTime := form22.datamov;
           dm.IBQuery1.ParamByName('pago').AsCurrency:= valorb;
           try
             if ((Form22.Pgerais.Values['nota'] = 'T') or (Form22.Pgerais.Values['nota'] = 'D')) then
               begin
                 form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|'+copy(IBTable1HISTORICO.AsString,1,length(IBTable1HISTORICO.AsString) - 5),FormatCurr('#,###,###0.00',valorb)+'|',' ',40)+#13+#10)));
               end
             else
               begin
                 funcoes.QuebraLinhas(#179,#179,' '+FormatDateTime('dd/mm/yy', IBTable1VENCIMENTO.AsDateTime)+'  '+ IBTable1HISTORICO.AsString +'          '+FormatCurr('#,###,###0.00', valorb),78);
                 //addRelatorioForm19(funcoes.CompletaOuRepete('|' + FormatDateTime('dd/mm/yy', IBTable1DATA.AsDateTime) + ' ' + funcoes.CompletaOuRepete(IBTable1HISTORICO.AsString, FormatCurr('#,###,###0.00', valorb), ' ', 50),'|', ' ', 70) + #13 + #10);
               end;
             dm.IBQuery1.ExecSQL;
             dm.IBQuery1.Transaction.Commit;
           except
           end;
         end;


       IBTable1.First;
       IBTable1.MoveBy(i);
       IBTable1.EnableControls;
       IBTable1.Close;
       IBTable1.Active := true;
       geraSaldo;
       if ((Form22.Pgerais.Values['nota'] = 'T') or (Form22.Pgerais.Values['nota'] = 'D')) then
         begin
           form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('+','+','-',40)+#13+#10)));
         end
       else
         begin
           dm.IBQuery2.Close;
           dm.IBQuery2.SQL.Text := ('select ende,bairro,cnpj,telres,telcom,cid,est from registro');
           dm.IBQuery2.Open;

           form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',78)+#13+#10))));
           form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',78)+#13+#10))));
           form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',78)+#13+#10))));
           form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',78)+#13+#10))));
           form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',78)+#13+#10))));
           form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',78)+#13+#10))));
           form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',78)+#13+#10))));
           form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#195,#194,#196,30)+funcoes.CompletaOuRepete('',#194,#196,15)+funcoes.CompletaOuRepete('',#180,#196,33)+#13+#10))));
           form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179+' CHEQUE Nr.:',#179,' ',30)+funcoes.CompletaOuRepete(' BANCO:',#179,' ',15)+funcoes.CompletaOuRepete(' CONTA:',#179,' ',33)+#13+#10))));
           form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',30)+funcoes.CompletaOuRepete('',#179,' ',15)+funcoes.CompletaOuRepete('',#179,' ',33)+#13+#10))));
           form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#195+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#196+#193,#197,#196,45)+funcoes.CompletaOuRepete('',#180,#196,33)+#13+#10))));
           form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',45)+funcoes.CompletaOuRepete('',#179,' ',33)+#13+#10))));
           form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179+'   '+dm.IBQuery2.fieldbyname('cid').AsString+' - '+dm.IBQuery2.fieldbyname('est').AsString+', '+FormatDateTime('dd',form22.datamov)+' DE '+UpperCase(FormatDateTime('MMMM',form22.datamov))+' DE '+FormatDateTime('YYYY',form22.datamov),#179,' ',45)+funcoes.CompletaOuRepete('',#179,' ',33)+#13+#10))));
           form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#179,#179,' ',45)+funcoes.CompletaOuRepete('            Assinatura',#179,' ',33)+#13+#10))));
           form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar((funcoes.CompletaOuRepete(#192,#193,#196,45)+funcoes.CompletaOuRepete('',#217,#196,33)+#13+#10))));
           {dm.IBQuery4.Close;
           dm.IBQuery4.SQL.Clear;
           dm.IBQuery4.SQL.Add('select * from registro');
           dm.IBQuery4.Open;

           addRelatorioForm19(funcoes.CompletaOuRepete('+','+', '-', 26) + funcoes.CompletaOuRepete('','+', '-', 16) + funcoes.CompletaOuRepete('','+', '-', 28) + #13 + #10);
           addRelatorioForm19(funcoes.CompletaOuRepete('| CHEQUE N.:' ,'|', ' ', 26) + funcoes.CompletaOuRepete(' BANCO: ','|', ' ', 16) + funcoes.CompletaOuRepete(' CONTA:','|', ' ', 28) + #13 + #10);
           addRelatorioForm19(funcoes.CompletaOuRepete('|' ,'|', ' ', 26) + funcoes.CompletaOuRepete('','|', ' ', 16) + funcoes.CompletaOuRepete('','|', ' ', 28) + #13 + #10);
           addRelatorioForm19(funcoes.CompletaOuRepete('+','+', '-', 26) + funcoes.CompletaOuRepete('','+', '-', 16) + funcoes.CompletaOuRepete('','+', '-', 28) + #13 + #10);
           addRelatorioForm19(funcoes.CompletaOuRepete('|','|', ' ', 42) + funcoes.CompletaOuRepete('','|', ' ', 28) + #13 + #10);
           addRelatorioForm19(funcoes.CompletaOuRepete('|' + dm.IBQuery4.fieldbyname('cid').AsString + ' - ' + dm.IBQuery4.fieldbyname('est').AsString + ', ' + FormatDateTime('d', Form22.datamov) + ' DE ' + UpperCase(FormatDateTime('mmmm', Form22.datamov)) + ' DE ' + FormatDateTime('yyyy', Form22.datamov)  ,'|', ' ', 42) + funcoes.CompletaOuRepete('','|', ' ', 28) + #13 + #10);
           addRelatorioForm19(funcoes.CompletaOuRepete('|','|', ' ', 42) + funcoes.CompletaOuRepete('  RECEBIDO POR VENDEDOR','|', ' ', 28) + #13 + #10);
           addRelatorioForm19(funcoes.CompletaOuRepete('+','+', '-', 42) + funcoes.CompletaOuRepete('','+', '-', 28) + #13 + #10);}
         end;
       sim := funcoes.valorPorExtenso(v1);
       sim := UpperCase(sim);
       valorbaixado := '';
       i := 0;
       while i <> length(sim) do
         begin
           i := i + 1;
           if sim[i] = ' ' then a := i;
           valorbaixado := valorbaixado + sim[i];
           if length(valorbaixado) = 38 then
             begin
               if ((Form22.Pgerais.Values['nota'] = 'T') or (Form22.Pgerais.Values['nota'] = 'D')) then
                 begin
                   form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|'+TrimLeft(copy(valorbaixado,1,a)),'|',' ',40)+#13+#10)));
                 end;
               valorbaixado := copy(valorbaixado,length(copy(valorbaixado,1,a)),length(valorbaixado));
             end
           else if i = length(sim) then
             begin
               if ((Form22.Pgerais.Values['nota'] = 'T') or (Form22.Pgerais.Values['nota'] = 'D')) then form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|'+TrimLeft(valorbaixado),'|',' ',40)+#13+#10)));
             end;
         end;
         if ((Form22.Pgerais.Values['nota'] = 'T') or (Form22.Pgerais.Values['nota'] = 'D')) then
           begin
             form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('+','+','-',40)+#13+#10)));
             form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|','|',' ',40)+#13+#10)));
             form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|RECEBIDO POR:','|',' ',40)+#13+#10)));
             form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|','|',' ',40)+#13+#10)));
             form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('|','|',' ',40)+#13+#10)));
             form19.RichEdit1.Perform(EM_REPLACESEL, 1, Longint(PChar(funcoes.CompletaOuRepete('+','+','-',40)+#13+#10)));
           end;
         IBTable1.Active :=true;
         if dm.IBQuery1.Transaction.InTransaction then dm.IBQuery1.Transaction.Commit;
         sim := funcoes.dialogo('generico',0,'SN',0,false,'S',Application.Title,'Deseja Imprimir o Recibo de Pagamento?','N') ;

         dm.IBQuery4.Close;

         if sim='S' then
         begin
           imprime.setCofiguracoesImpressora;
           imprime.textxArq('texto.txt');
          //form19.RichEdit1.Lines.SaveToFile('texto.txt');
          //imprime.textx(GetCurrentDir+'\texto.txt');
         end;
       end;
     end


 end;

procedure TForm34.DBGrid1KeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
var
  data : string;
begin
 if cont=2 then
  begin
    if key = 116 then
      begin
        data := '';
        if IBTable1PREVISAO.AsString <> '01/01/1900'  then data := IBTable1PREVISAO.AsString;
        data := funcoes.dialogo('data',0,'1234567890'+#8,50,true,'',Application.Title,'Qual a Previsão para Pagamento?',data);
        if data = '*' then exit;

        IBTable1.Open;
        IBTable1.Edit;
        IBTable1PREVISAO.AsDateTime := StrToDateTime(data);
        IBTable1.Post;

      end;
  end;
end;
end.
